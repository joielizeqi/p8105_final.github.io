---
title: "NYC Dog Bites"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(rsconnect)
library(leaflet)
library(readr)
library(ggplot2)
library(knitr)
library(shiny)
#install.packages("leaflet.extras")
library(leaflet.extras)
#install.packages(c("knitr", "rmarkdown"))

#install.packages("tidygeocoder")
library(tidygeocoder)
library(dplyr)
library(lubridate)

#install.packages("rsconnect")
library(rsconnect)
```

```{r}
bite = read_csv("./data/Dog_Bites_w_Location_data.csv", 
           na = c("NA", ".", "")) |>
  janitor::clean_names() %>% 
  filter(gender != "U") %>% 
  na.omit()
```

Select Squirrel Details {.sidebar}
-----------------------------------------------------------------------

### NYC Dog Bites


```{r}

breed_vec <- c("All", bite |> filter(!is.na(breed)) |> pull(breed) |> unique())

year_vec <- c("All", bite |> filter(!is.na(year)) |> pull(year) |> unique())

selectInput(
  inputId = "year_choice",
  label = "Year of Bite",
  choices = year_vec,
  selected = "All"
)

selectInput(
  inputId = "breed_choice",
  label = "Breed",
  choices = breed_vec,
  selected = "All"
)

spay_status_vec <- c("All", bite |> 
  mutate(spay_status = case_when(
    spay_neuter == TRUE ~ "Spayed/Neutered",
    spay_neuter == FALSE ~ "Not Spayed/Neutered",
    .default = "Unknown"
  )) |> 
  pull(spay_status) |> 
  unique())

selectInput(
  inputId = "spay_status_choice",
  label = "Spay/Neuter Status",
  choices = spay_status_vec,
  selected = "All"
)

gender_vec <- c("All", bite |> pull(gender) |> unique())

selectInput(
  inputId = "gender_choice",
  label = "Gender",
  choices = gender_vec,
  selected = "All"
)
```


Column {data-width=340}
-----------------------------------------------------------------------
### Interactive Dog Bites Heatmap

```{r}
bite <- bite |> 
  mutate(year = as.numeric(format(as.Date(date_of_bite), "%Y")),
      rounded_lat = round(lat, 3), 
      rounded_long = round(long, 3)
         )

bite_mutated <- bite |> 
  mutate(spay_status = case_when(
    spay_neuter == TRUE ~ "Spayed/Neutered",
    spay_neuter == FALSE ~ "Not Spayed/Neutered",
    .default = "Unknown"
  ))



dog_bite_map <- bite_mutated |> 
  filter(!is.na(lat) & !is.na(long))

renderLeaflet({
  # Filter the dataset
  dog_bite_map <- bite |> 
    mutate(
      spay_status = case_when(
        spay_neuter == TRUE ~ "Spayed/Neutered",
        spay_neuter == FALSE ~ "Not Spayed/Neutered",
        .default = "Unknown"
      ),
      year = as.numeric(format(as.Date(date_of_bite), "%Y"))
    ) |> 
    filter(!is.na(lat) & !is.na(long))

  # Apply user-selected filters
  if (!is.null(input[["breed_choice"]]) && input[["breed_choice"]] != "All") {
    dog_bite_map <- dog_bite_map |> filter(breed == input[["breed_choice"]])
  }

  if (!is.null(input[["spay_status_choice"]]) && input[["spay_status_choice"]] != "All") {
    dog_bite_map <- dog_bite_map |> filter(spay_status == input[["spay_status_choice"]])
  }

  if (!is.null(input[["gender_choice"]]) && input[["gender_choice"]] != "All") {
    dog_bite_map <- dog_bite_map |> filter(gender == input[["gender_choice"]])
  }

  if (!is.null(input[["year_choice"]]) && input[["year_choice"]] != "All") {
    dog_bite_map <- dog_bite_map |> filter(year == as.numeric(input[["year_choice"]]))
  }


  # Generate the heat map
  leaflet(data = dog_bite_map) |> 
    addTiles() |> 
    addProviderTiles("CartoDB.Positron") |> 
    addHeatmap(
      lng = ~long,
      lat = ~lat,
      intensity = ~2,   
      blur = 19,        
      max = 1,          
      radius = 20       
    )
})

leafletOutput("heatmap", height = "600px")

```

Column {data-width=300}
-----------------------------------------------------------------------
### Number of Dog Bites by month

```{r}
bite_factor = bite %>% 
    mutate(
  year = as.factor(year(date_of_bite)), 
  month = sprintf("%02d", month(date_of_bite)) 
)

bite_summary <- bite_factor %>%
  mutate(month = format(as.Date(date_of_bite), "%m"),
         year = format(as.Date(date_of_bite), "%Y")) %>%
  count(year, month) %>%
  mutate(year = as.factor(year))

plot_ly(
  data = bite_summary,
  x = ~month,
  y = ~n,
  color = ~year,
  type = 'bar',
  colors = "Blues"
) %>%
layout(
  title = "Dog Bites by Month",
  xaxis = list(title = "Month"),
  yaxis = list(title = "Count of Dog Bites"),
  barmode = "stack",
  height = 400
)
```


### Top 15 Dog Bite Breeds by Year

```{r}
ui <- fluidPage(
  tags$style(HTML("
    .radio-inline {
      margin-right: 5px;
      padding: 2px 20px; 
      font-size: 12px; 
    }
    .well { 
      padding: 1px; 
    }
    label { 
      margin-bottom: 0px; 
    }
  ")), 

  sidebarLayout(
    sidebarPanel(
      radioButtons(
        inputId = "year_choice",
        label = "Select Year:",
        choices = unique(bite$year),
        selected = max(bite$year),  # Default to most recent year
        inline = TRUE  # Display radio buttons in one line
      )
    ),
    mainPanel(
      plotlyOutput("treemap_plot", width = "640", height = "400px")
    )
  )
)

# Server
server <- function(input, output, session) {
  output$treemap_plot <- renderPlotly({
    # Filter data based on selected year
    filtered_data <- bite %>%
      filter(year == input$year_choice, !is.na(breed)) %>%
      group_by(breed) %>%
      summarise(count = n()) %>%
      arrange(desc(count)) %>%
      slice_max(order_by = count, n = 15)  # Top 15 breeds

    # Plotly Treemap
    plot_ly(
      data = filtered_data,
      type = "treemap",
      labels = ~breed,
      parents = "",
      values = ~count,
      textinfo = "label+value",
      marker = list(colors = "Purples")
    ) 
  })
}

# Run the app
shinyApp(ui, server)

```

